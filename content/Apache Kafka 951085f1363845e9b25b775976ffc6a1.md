# Apache Kafka

RabbitMQâ€™ya benzer ÅŸekilde yine bir message brokerâ€™dir.

YapÄ±sÄ± ÅŸu ÅŸekildedir:

![Untitled](Apache%20Kafka%20951085f1363845e9b25b775976ffc6a1/Untitled.png)

Topic: Bir depodur. Producer Ã¼rettiklerini buraya koyar. Consumer da oradan alarak tÃ¼ketir. RabbitMQâ€™daki queue gibidir. Birden fazla topic oluÅŸturulabilir.

<aside>
ğŸ’¡ Index yapÄ±sÄ± ile Ã§alÄ±ÅŸÄ±r. AynÄ± SQL veritabanlarÄ±ndaki gibi her eklenen veri, 0â€˜dan baÅŸlayan indexâ€™i 1 artÄ±rÄ±rak gider.

</aside>

Topic, daha alt baÅŸlÄ±klara bÃ¶lÃ¼nebilir. Yani log tiplerine gÃ¶re daha alt topicler oluÅŸturulabilir. BÃ¶ylece istenen aynÄ± kategorideki verilere daha hÄ±zlÄ± ulaÅŸÄ±lÄ±r. Bu alt topicâ€™in adÄ± partitionâ€™dur. Birden Ã§ok partition oluÅŸturulabilir. Consumerâ€™da ilgili partitionâ€™a join olarak sadece o partitionâ€™Ä± tÃ¼ketebiliyor.

![Untitled](Apache%20Kafka%20951085f1363845e9b25b775976ffc6a1/Untitled%201.png)

## Kafka vs RabbitMQ

RabbitMQ adÄ± Ã¼zerinde bir message queueâ€™dir. Kuyruktan veri gÃ¶nderir ve tÃ¼ketir. 

Ancak Kafka sadece bir queue deÄŸildir. AyrÄ±ca pub-sub da saÄŸlar.

![Untitled](Apache%20Kafka%20951085f1363845e9b25b775976ffc6a1/Untitled%202.png)

<aside>
ğŸ’¡ Pub-sub rabbitmq ile de yapÄ±labilir ama ana amacÄ± bu deÄŸildir ve bunu yapmak iÃ§in taklalar atmak gerekir.

</aside>

## Pub - Sub nedir?

Bir kiÅŸinin publish edip farklÄ± consumerâ€™lerin o kaynaktan tÃ¼ketebildiÄŸi yapÄ±dÄ±r.

Mesela video paylaÅŸÄ±m platformlarÄ±. Biz videoyu platforma istediÄŸimiz bir Ã§Ã¶zÃ¼nÃ¼rlÃ¼kte yÃ¼kleriz ve platform kendisi o videonun farklÄ± Ã§Ã¶zÃ¼nÃ¼rlÃ¼klerini(daha dÃ¼ÅŸÃ¼k) oluÅŸturur(encoders). 

Burada publisher biz oluruz. Ã‡Ã¼nkÃ¼ aslÄ±da vidoyu yÃ¼kleyerek kafkaya publish ederiz. Encoderâ€™ler ise o videoyu alarak encode iÅŸlemlerini yaparlar.

![Untitled](Apache%20Kafka%20951085f1363845e9b25b775976ffc6a1/Untitled%203.png)

### Consumer Group

![Untitled](Apache%20Kafka%20951085f1363845e9b25b775976ffc6a1/Untitled%204.png)

Consumer Group denen yapÄ± iÃ§inde birden fazla consumer oluÅŸturulabilir. Her bir consumer tek bir partitionâ€™u tÃ¼ketir(tÃ¼ketmelidir. Ä°deali budur). Her iki consumer da aynÄ± anda farklÄ± partitionâ€™larÄ± tÃ¼kettiÄŸi iÃ§in paralel olarak Ã§alÄ±ÅŸÄ±rlar.

## Pub - Sub With Consumer Group

![Untitled](Apache%20Kafka%20951085f1363845e9b25b775976ffc6a1/Untitled%205.png)

Her bir consumer group parititon 1â€™e attach olduÄŸunda paralel olarak raw videolarÄ± tÃ¼ketecekler.

![Untitled](Apache%20Kafka%20951085f1363845e9b25b775976ffc6a1/Untitled%206.png)

# ZooKeeper

Kafka iÃ§in verileri tutan bÃ¶lÃ¼m diyebiliriz

FarklÄ± serverâ€™larda aynÄ± kafka topicâ€™i tutulabilir. BÃ¶ylece clustered yapÄ± kurulur. Sadece masterâ€™a yazma yapÄ±lÄ±r ancak slaveâ€™lerden de okuma yapÄ±labilir.

Masterâ€™da bir partition Ã§Ã¶kerse yeni gelecek veriler kaybedilir Ã§Ã¼nkÃ¼ master dÄ±ÅŸÄ±nda bir yere veri yazÄ±lamaz.

Ancak biz iki serverimizi olduÄŸunu dÃ¼ÅŸÃ¼nelim. Burada birinci serverin partition 1â€™ini master yapÄ±p, server 2â€™nin partititon 2â€™sini master yaparsam bir Ã§Ã¶kme anÄ±nda en azÄ±ndan bir partitionâ€™u kurtarabilirim.

<aside>
ğŸ’¡ Kafkaâ€™da masterâ€™e leader, slaveâ€™lere follower adÄ± verilir.

</aside>

Peki bir yazma iÅŸleminde partition2â€™nin master olduÄŸunu nasÄ±l bileceÄŸiz. Bunu sÃ¼rekli aklmÄ±zda mÄ± tutucaz. HayÄ±r!

ZooKeeper bizim iÃ§in tabiri caizse â€œdedikoduâ€(hatta bu yÃ¼zden buna Gossip protokolÃ¼ denir) yaparak masteri bulur.

Ancak tek yaptÄ±ÄŸÄ± ÅŸey bu deÄŸildir. Kafka, ZooKeeper olmadan Ã§alÄ±ÅŸmaz. Ã‡Ã¼nkÃ¼ Ã¼retilen mesajlarÄ±n bir yerde depolanmasÄ± gerekir. Zookeeper da onu saÄŸlar.

---

<aside>
ğŸ’¡ EÄŸer bir partitionâ€™u 2 consumere baÄŸlarsak ilk aÃ§Ä±lan consumer verileri aldÄ±ktan sonra rebalance eder. Bak benden baÅŸka, o partitionu okuyan birine denk geldim. Bir partitionu sadece bir consumer okuyacaÄŸÄ± iÃ§in hadi bana selamun aleykÃ¼m deyip kendini kapar ve baÅŸka mesaj almaz.

</aside>

<aside>
ğŸ’¡ EÄŸitimin github kodu

</aside>

[https://github.com/gkandemi/apache-kafka](https://github.com/gkandemi/apache-kafka)